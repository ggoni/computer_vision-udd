groups:
- name: computer_vision_alerts
  rules:
  # API Performance Alerts
  - alert: HighAPILatency
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="cv-api"}[5m])) > 2.0
    for: 2m
    labels:
      severity: warning
      service: cv-api
    annotations:
      summary: "High API latency detected"
      description: "95th percentile latency is {{ $value }}s for CV API"

  - alert: HighErrorRate
    expr: rate(http_requests_total{job="cv-api",status=~"5.."}[5m]) > 0.1
    for: 1m
    labels:
      severity: critical
      service: cv-api
    annotations:
      summary: "High error rate in CV API"
      description: "Error rate is {{ $value }} errors/sec"

  # ML Model Performance Alerts
  - alert: LowModelConfidence
    expr: histogram_quantile(0.50, rate(model_prediction_confidence_bucket[10m])) < 0.3
    for: 5m
    labels:
      severity: warning
      service: cv-model
    annotations:
      summary: "Low model confidence detected"
      description: "Median model confidence is {{ $value }}"

  - alert: ModelInferenceSlowdown
    expr: histogram_quantile(0.95, rate(model_inference_duration_seconds_bucket[5m])) > 5.0
    for: 3m
    labels:
      severity: warning
      service: cv-model
    annotations:
      summary: "Model inference is slow"
      description: "95th percentile inference time is {{ $value }}s"

  # Resource Usage Alerts  
  - alert: HighMemoryUsage
    expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.8
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage in {{ $labels.container_label_com_docker_compose_service }}"
      description: "Memory usage is {{ $value | humanizePercentage }}"

  - alert: HighCPUUsage
    expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage in {{ $labels.container_label_com_docker_compose_service }}"
      description: "CPU usage is {{ $value | humanizePercentage }}"

  # Database Alerts
  - alert: DatabaseConnectionHigh
    expr: pg_stat_activity_count > 80
    for: 2m
    labels:
      severity: warning
      service: postgres
    annotations:
      summary: "High number of database connections"
      description: "Current connections: {{ $value }}"

  - alert: DatabaseSlowQueries
    expr: rate(pg_stat_statements_mean_time_seconds[5m]) > 1.0
    for: 2m
    labels:
      severity: warning
      service: postgres
    annotations:
      summary: "Slow database queries detected"
      description: "Average query time: {{ $value }}s"

  # Storage Alerts
  - alert: DiskSpaceLow
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Low disk space"
      description: "Available disk space is {{ $value | humanizePercentage }}"

  - alert: MinIOHighUsage
    expr: (minio_disk_storage_used_bytes / minio_disk_storage_total_bytes) > 0.8
    for: 5m
    labels:
      severity: warning
      service: minio
    annotations:
      summary: "MinIO storage usage is high"
      description: "Storage usage is {{ $value | humanizePercentage }}"